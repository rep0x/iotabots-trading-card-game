import React from "react";
import Head from "next/head";
import { useRouter } from "next/router";
import { useUser } from "@clerk/nextjs";
import { Box, Typography } from "@mui/material";

import GameLayout from "@/layouts/Game";
import Infos from "@/components/game/Infos";
import { GameContext } from "@/context/GameContext";
import Board from "@/components/game/Board";
import GameState from "@/components/game/GameState";
import Button from "@/components/Button";
import Refetch from "@/components/game/Refetch";

export default function Game() {
  const { game, refetch } = React.useContext(GameContext);
  const { user } = useUser();
  const { push } = useRouter();

  React.useEffect(() => {
    refetch();
  }, []);

  if (!user) {
    return <></>;
  }

  if (game === undefined) {
    return (
      <GameLayout>
        <Typography variant="h1">Game loading...</Typography>
      </GameLayout>
    );
  }

  if (game === null) {
    return (
      <GameLayout>
        <Typography variant="h1">No active game</Typography>
        <Button onClick={() => push("/")}>Back to Menu</Button>
      </GameLayout>
    );
  }

  const me = game.player1Id === user.id ? "player1Id" : "player2Id";
  const opponent = me === "player1Id" ? "player2Id" : "player1Id";

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <GameLayout>
        <Infos />
        <Refetch />
        <Box sx={styles.root}>
          <Board player={opponent} />
          <GameState />
          <Board player={me} />
        </Box>
      </GameLayout>
    </>
  );
}

const styles = {
  root: {
    display: "flex",
    flexDirection: "column",
    height: "100%",
    gap: 4,
  },
};
